esphome:
  name: van-heizung
  friendly_name: van-heizung

esp32:
  board: esp32dev
  framework:
    type: esp-idf

external_components:
  - source: github://ElektronB/esphome-sunster-heater@main
    components: [sunster_heater]
    refresh: 0s  # Einmalig: Cache neu laden, danach z.B. 1d

logger:
  level: DEBUG

api:
  encryption:
    key: "ieLzn/ZYWI8TX5wVKSPcZHNtjeXI4d8JnEH8RTjOGDI="

ota:
  - platform: esphome
    password: "3760e2680917e59e38dc8d3a80e7dcba"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

uart:
  id: heater_uart
  rx_pin:
    number: GPIO17
    inverted: true
  tx_pin:
    number: GPIO16
    inverted: true
  baud_rate: 4800

# 1-Wire Bus (DS18B20 o.ä.) – 4,7 kΩ Pull-up zwischen Data und 3,3 V
# Pin: GPIO4, GPIO32 oder GPIO33 (ESP32: nur Pins mit Ein+Ausgang; GPIO28 existiert am ESP32 nicht)
one_wire:
  - platform: gpio
    pin: GPIO32
    id: one_wire_bus

sensor:
  # Index 0 = Raumtemperatur (für PI-Regelung), Index 1 = Luftauslass
  # Bei mehreren Sensoren besser address: 0x... aus dem Log verwenden (stabil)
  - platform: dallas_temp
    one_wire_id: one_wire_bus
    address: 0xd43ce1e3810bed28
    id: raumtemperatur
    name: "Raumtemperatur"
    update_interval: 5s   # Alle 5s für PI-Prädiktion
    resolution: 12       # 12-bit, float durchgängig in Regler
    filters:
      - filter_out: nan

sunster_heater:
  id: my_heater
  uart_id: heater_uart
  # passive_sniff: true   # Nur RX loggen + Decode, kein Senden (nur wenn Komponente diese Option hat)
  control_mode: automatic
  external_temperature_sensor: raumtemperatur
  target_temperature: 18.0
  # PID-Regler (abgestimmt auf ~0,5°C/min Aufheizung): Stellwert 0–100 %, unter min_off aus, ab min_on ein
  pi_kp: 20.0
  pi_ki: 0.15
  pi_kd: 1.0
  pi_off_delay: 30.0
  pi_output_min_off: 3.0
  pi_output_min_on: 10.0
  t_lookahead: 90
  slope_window: 45
  output_off_threshold: -10
  output_on_threshold: 10
  default_power_percent: 10
  min_voltage_start: 12.0
  min_voltage_operate: 10.0
  polling_interval: 5s
  injected_per_pulse: 0.022

  power_switch:
    name: "Heizung Ein-Aus"
  power_level_number:
    name: "Heizung Leistung"
    mode: slider
  control_mode_select:
    name: "Heizung Modus"

  # Automatik-Modus: PI-Regler + Hysterese (UI-einstellbar)
  pi_kp_number:
    name: "Heizung PI Kp"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 20
  pi_ki_number:
    name: "Heizung PI Ki"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 0.1
  pi_kd_number:
    name: "Heizung PI Kd"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 0.2
  pi_off_delay_number:
    name: "Heizung Abschalt-Verzögerung (s)"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 60
    min_value: 0
    max_value: 600
    step: 10
  pi_on_delay_number:
    name: "Heizung Einschalt-Verzögerung (s)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: 30
    min_value: 0
    max_value: 600
    step: 5
  target_temperature_number:
    name: "Heizung Solltemperatur"
    mode: slider
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 21
  pi_output_min_off_number:
    name: "Heizung Hysterese Aus (Stellwert %)"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 3
  pi_output_min_on_number:
    name: "Heizung Hysterese Ein (Stellwert %)"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 10
  pi_min_on_time_number:
    name: "Heizung Min-On-Zeit (s)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: 30
    min_value: 0
    max_value: 300
    step: 5
  t_lookahead_number:
    name: "Heizung Vorausschau (s)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: 90
    min_value: 30
    max_value: 300
    step: 5
  slope_window_number:
    name: "Heizung Steigungsfenster (s)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: 45
    min_value: 10
    max_value: 120
    step: 5
  output_off_threshold_number:
    name: "Heizung Regler Aus-Schwelle (%)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: -10
    min_value: -100
    max_value: 0
    step: 1
  output_on_threshold_number:
    name: "Heizung Regler Ein-Schwelle (%)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: 10
    min_value: 0
    max_value: 100
    step: 1

  injected_per_pulse_number:
    name: "Fuel Injected Per Pulse"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    min_value: 0.001
    max_value: 0.10
    step: 0.001
    initial_value: 0.022

  reset_total_consumption_button:
    name: "Reset Total Fuel Consumption"
  pid_autotune_button:
    name: "PID Auto-Tune"