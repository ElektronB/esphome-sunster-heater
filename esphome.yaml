esphome:
  name: van-heater
  friendly_name: van-heater

esp32:
  board: esp32dev
  framework:
    type: esp-idf

external_components:
  - source: github://ElektronB/esphome-sunster-heater@main
    components: [sunster_heater]
    refresh: 0s  # One-time cache refresh; then e.g. 1d

logger:
  level: DEBUG

api:
  encryption:
    key: "ieLzn/ZYWI8TX5wVKSPcZHNtjeXI4d8JnEH8RTjOGDI="

ota:
  - platform: esphome
    password: "3760e2680917e59e38dc8d3a80e7dcba"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

uart:
  id: heater_uart
  rx_pin:
    number: GPIO17
    inverted: true
  tx_pin:
    number: GPIO16
    inverted: true
  baud_rate: 4800

# 1-Wire bus (DS18B20 etc.) – 4.7 kΩ pull-up between data and 3.3 V
# Pin: GPIO4, GPIO32 or GPIO33 (ESP32: input+output capable pins only)
one_wire:
  - platform: gpio
    pin: GPIO32
    id: one_wire_bus

sensor:
  # Room temperature for PI control; use address from log if you have multiple sensors
  # Keine Mittelung/Filter – rohe Messwerte für Predictor-Tuning
  - platform: dallas_temp
    one_wire_id: one_wire_bus
    address: 0xd43ce1e3810bed28
    id: room_temperature
    name: "Room Temperature"
    update_interval: 5s   # 5s for PI prediction
    resolution: 12       # 12-bit, float throughout in controller
    filters:
      - filter_out: nan   # Nur NaN ausfiltern, keine Mittelung

sunster_heater:
  id: my_heater
  uart_id: heater_uart
  # passive_sniff: true   # Log RX/decode only, no TX
  control_mode: automatic
  external_temperature_sensor: room_temperature
  target_temperature: 18.0
  # PI controller: output ±100%, on/off via thresholds
  pi_kp: 20.0
  pi_ki: 0.15
  t_lookahead: 90
  slope_window: 45
  output_off_threshold: -10
  output_on_threshold: 10
  default_power_percent: 10
  min_voltage_start: 12.0
  min_voltage_operate: 10.0
  polling_interval: 5s
  injected_per_pulse: 0.022

  power_switch:
    name: "Heater On-Off"
  power_level_number:
    name: "Heater Power"
    mode: slider
  control_mode_select:
    name: "Heater Mode"

  # Automatic mode: PI controller, thresholds, prediction (UI configurable)
  pi_kp_number:
    name: "Heater PI Kp"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 20
  pi_ki_number:
    name: "Heater PI Ki"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 0.1
  target_temperature_number:
    name: "Heater Target Temperature"
    mode: box   
    restore_value: true  # Saves value to flash
    optimistic: true
    initial_value: 21
  pi_min_on_time_number:
    name: "Heater Min-On Time (s)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: 30
    min_value: 0
    max_value: 300
    step: 5
  t_lookahead_number:
    name: "Heater Lookahead (s)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: 90
    min_value: 30
    max_value: 300
    step: 5
  slope_window_number:
    name: "Heater Slope Window (s)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: 45
    min_value: 10
    max_value: 120
    step: 5
  output_off_threshold_number:
    name: "Heater Off Threshold (%)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: -10
    min_value: -100
    max_value: 0
    step: 1
  output_on_threshold_number:
    name: "Heater On Threshold (%)"
    mode: box
    restore_value: true
    optimistic: true
    initial_value: 10
    min_value: 0
    max_value: 100
    step: 1

  injected_per_pulse_number:
    name: "Fuel Injected Per Pulse"
    mode: box
    restore_value: true  # Saves value to flash
    optimistic: true
    min_value: 0.001
    max_value: 0.10
    step: 0.001
    initial_value: 0.022

  reset_total_consumption_button:
    name: "Reset Total Fuel Consumption"

climate:
  - platform: sunster_heater
    sunster_heater_id: my_heater
    name: "Van Heater"
    min_temperature: 5
    max_temperature: 35